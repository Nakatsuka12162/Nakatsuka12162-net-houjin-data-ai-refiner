{% extends 'admin/base.html' %} {% load static %} {% block content %}
<style>
  .config-btn-cell {
    white-space: nowrap;
  }
  
  /* Ensure modal footer buttons are visible */
  .modal-footer {
    display: flex !important;
    gap: 0.875rem !important;
    justify-content: flex-end !important;
    padding: 1.25rem 2rem !important;
    border-top: 1px solid #e5e7eb !important;
    background: #fafbfc !important;
  }
  
  .modal-footer .btn {
    display: inline-flex !important;
    align-items: center !important;
    gap: 0.375rem !important;
    padding: 0.625rem 1.25rem !important;
    font-weight: 600 !important;
    font-size: 0.9375rem !important;
    border-radius: 8px !important;
    transition: all 0.2s !important;
  }
  
  @media (max-width: 768px) {
    .card-header h2 {
      font-size: 0.9rem;
    }
    .config-btn-cell .btn {
      font-size: 0.7rem;
      padding: 0.2rem 0.4rem;
    }
    .modal-footer {
      flex-direction: row !important;
      gap: 0.5rem !important;
    }
    .modal-footer .btn {
      flex: 1 !important;
    }
  }
</style>
{% csrf_token %}
<div class="card">
  <div
    class="card-header"
    style="
      display: flex;
      align-items: center;
      justify-content: space-between;
      flex-wrap: wrap;
      gap: 1rem;
    "
  >
    <h2 style="margin: 0">
      <i class="fas fa-robot"></i> ã‚¹ã‚¯ãƒ¬ã‚¤ãƒ”ãƒ³ã‚°å±¥æ­´ ({{ executions.paginator.count }})
    </h2>
    <button onclick="showConfigModal()" class="btn btn-success">
      <i class="fas fa-play"></i> æ–°è¦ã‚¹ã‚¯ãƒ¬ã‚¤ãƒ”ãƒ³ã‚°é–‹å§‹
    </button>
  </div>
  <div class="card-body">
    <div class="table-wrapper">
      <table class="table">
        <thead>
          <tr>
            <th>ID</th>
            <th>é–‹å§‹æ—¥æ™‚</th>
            <th>ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹</th>
            <th>é€²æ—</th>
            <th>å®Ÿè¡Œæ™‚é–“</th>
            <th>è¨­å®š</th>
          </tr>
        </thead>
        <tbody>
          {% for execution in executions %}
          <tr>
            <td>
              <code
                style="
                  background: #f3f4f6;
                  padding: 0.125rem 0.375rem;
                  border-radius: 4px;
                "
              >
                #{{ execution.id }}
              </code>
            </td>
            <td style="white-space: nowrap">
              <span style="color: #0891b2">
                <i class="fas fa-clock"></i> {{ execution.started_at|date:"Y-m-d H:i:s" }}
              </span>
            </td>
            <td>
              {% if execution.status == 'running' %}
              <span class="badge" style="background: #ffa500; color: white">
                <i class="fas fa-spinner fa-spin"></i> å®Ÿè¡Œä¸­
              </span>
              {% elif execution.status == 'completed' %}
              <span class="badge" style="background: #28a745; color: white">
                <i class="fas fa-check"></i> å®Œäº†
              </span>
              {% elif execution.status == 'failed' %}
              <span class="badge" style="background: #dc3545; color: white">
                <i class="fas fa-times"></i> å¤±æ•—
              </span>
              {% endif %}
            </td>
            <td>
              {% if execution.total_companies > 0 %}
                {% widthratio execution.processed_companies execution.total_companies 100 as percentage %}
                <div style="display: flex; align-items: center; gap: 0.5rem">
                  <div style="width: 100px; height: 8px; background: #e9ecef; border-radius: 4px; overflow: hidden;">
                    <div style="width: {{ percentage }}%; height: 100%; background: #007cba;"></div>
                  </div>
                  <span style="font-size: 0.875rem; white-space: nowrap;">{{ execution.processed_companies }}/{{ execution.total_companies }} ({{ percentage }}%)</span>
                </div>
              {% else %}
                <span style="color: #9ca3af">{{ execution.processed_companies }}/0</span>
              {% endif %}
            </td>
            <td>
              {% if execution.completed_at %}
                {% with duration=execution.completed_at|timeuntil:execution.started_at %}
                  <span style="color: #059669">{{ duration }}</span>
                {% endwith %}
              {% else %}
                <span style="color: #9ca3af">-</span>
              {% endif %}
            </td>
            <td class="config-btn-cell">
              <div style="display: flex; gap: 0.5rem;">
                <button
                  onclick="showConfigDetails({{ execution.id }}, '{{ execution.spreadsheet_range|escapejs }}', '{{ execution.description|escapejs }}', {{ execution.max_companies|default:'null' }}, {{ execution.update_google_sheets|lower }})"
                  class="btn btn-secondary"
                  style="font-size: 0.75rem; padding: 0.25rem 0.5rem"
                >
                  <i class="fas fa-info-circle"></i> è©³ç´°è¡¨ç¤º
                </button>
                {% if execution.status == 'completed' and execution.processed_companies > 0 %}
                <a
                  href="{% url 'export_execution_data' execution.id %}"
                  class="btn btn-success"
                  style="font-size: 0.75rem; padding: 0.25rem 0.5rem"
                  title="ã™ã¹ã¦ã®ãƒ‡ãƒ¼ã‚¿ã‚’å«ã‚€Excelã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰"
                >
                  <i class="fas fa-download"></i> ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ
                </a>
                {% endif %}
              </div>
            </td>
          </tr>
          {% empty %}
          <tr>
            <td
              colspan="6"
              style="text-align: center; padding: 2rem; color: #9ca3af"
            >
              <div style="font-size: 2rem; margin-bottom: 0.5rem">
                <i class="fas fa-robot"></i>
              </div>
              <div>ã‚¹ã‚¯ãƒ¬ã‚¤ãƒ”ãƒ³ã‚°å±¥æ­´ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚</div>
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>

    {% if executions.has_other_pages %}
    <div class="pagination">
      {% if executions.has_previous %}
      <a href="?page=1" data-no-loading>&laquo; æœ€åˆ</a>
      <a href="?page={{ executions.previous_page_number }}" data-no-loading
        >&lsaquo; å‰ã¸</a
      >
      {% endif %}

      <span class="current"
        >{{ executions.number }} / {{ executions.paginator.num_pages }}</span
      >

      {% if executions.has_next %}
      <a href="?page={{ executions.next_page_number }}" data-no-loading
        >æ¬¡ã¸ &rsaquo;</a
      >
      <a href="?page={{ executions.paginator.num_pages }}" data-no-loading
        >æœ€å¾Œ &raquo;</a
      >
      {% endif %}
    </div>
    {% endif %}
  </div>
</div>

<!-- Configuration Modal -->
<div class="modal-overlay" id="configModal" onclick="if(event.target === this) hideConfigModal();">
  <div class="modal-content" style="max-width: 650px; display: flex; flex-direction: column; max-height: 90vh;">
    <div class="modal-header" style="flex-shrink: 0;">
      <h3><i class="fas fa-cog"></i> ã‚¹ã‚¯ãƒ¬ã‚¤ãƒ”ãƒ³ã‚°è¨­å®š</h3>
      <button type="button" class="modal-close" onclick="hideConfigModal()">
        <i class="fas fa-times"></i>
      </button>
    </div>
    <div class="modal-body" style="flex: 1; overflow-y: auto; max-height: none; padding: 1.5rem 2rem;">
      <form id="configForm">
        
        <!-- STEP 1: Data Source Selection -->
        <div style="background: #f8f9fa; padding: 1.25rem; border-radius: 10px; margin-bottom: 1.5rem; border: 2px solid #e9ecef;">
          <h4 style="margin: 0 0 1rem 0; color: #0891b2; font-size: 1rem; display: flex; align-items: center; gap: 0.5rem;">
            <i class="fas fa-database"></i> ã‚¹ãƒ†ãƒƒãƒ—1: ãƒ‡ãƒ¼ã‚¿ã‚½ãƒ¼ã‚¹ã‚’é¸æŠ
          </h4>
          
          <!-- Option 1: Google Sheets -->
          <div style="background: white; padding: 1rem; border-radius: 8px; margin-bottom: 1rem; border: 2px solid #e5e7eb; cursor: pointer; transition: all 0.2s;" 
               id="sheetsCard" 
               onclick="selectDataSource('sheets')">
            <label style="display: flex; align-items: start; margin: 0; cursor: pointer;">
              <input
                type="radio"
                name="dataSource"
                value="sheets"
                checked
                onchange="toggleDataSource()"
                style="margin-top: 0.25rem; margin-right: 0.75rem; width: 18px; height: 18px; cursor: pointer;"
              />
              <div style="flex: 1;">
                <div style="font-weight: bold; font-size: 1rem; margin-bottom: 0.5rem; display: flex; align-items: center; gap: 0.5rem;">
                  <i class="fas fa-table" style="color: #10b981;"></i>
                  Googleã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã‹ã‚‰å–å¾—
                </div>
                <div style="color: #6b7280; font-size: 0.875rem;">
                  æ—¢å­˜ã®Googleã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã‹ã‚‰ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿ã¾ã™
                </div>
                
                <!-- Sheets Options (shown when selected) -->
                <div id="sheetsOptions" style="margin-top: 1rem; padding-top: 1rem; border-top: 1px solid #e5e7eb;">
                  <label style="display: block; margin-bottom: 0.5rem; font-weight: 600; font-size: 0.875rem; color: #374151;">
                    <i class="fas fa-map-marked-alt"></i> ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆç¯„å›²:
                  </label>
                  <input
                    type="text"
                    id="spreadsheetRange"
                    value="ä¼šç¤¾ãƒªã‚¹ãƒˆ!A3:D"
                    placeholder="ä¾‹: ä¼šç¤¾ãƒªã‚¹ãƒˆ!A3:D50"
                    class="form-control"
                    style="font-family: monospace;"
                  />
                  <small style="color: #6b7280; display: block; margin-top: 0.25rem;">
                    ğŸ“Œ å‡¦ç†ã™ã‚‹ã‚»ãƒ«ç¯„å›²ã‚’æŒ‡å®šï¼ˆä¾‹: A3:D50ã§æœ€åˆã®50ç¤¾ï¼‰
                  </small>
                </div>
              </div>
            </label>
          </div>

          <!-- Option 2: Manual Input -->
          <div style="background: white; padding: 1rem; border-radius: 8px; border: 2px solid #e5e7eb; cursor: pointer; transition: all 0.2s;" 
               id="manualCard" 
               onclick="selectDataSource('manual')">
            <label style="display: flex; align-items: start; margin: 0; cursor: pointer;">
              <input
                type="radio"
                name="dataSource"
                value="manual"
                onchange="toggleDataSource()"
                style="margin-top: 0.25rem; margin-right: 0.75rem; width: 18px; height: 18px; cursor: pointer;"
              />
              <div style="flex: 1;">
                <div style="font-weight: bold; font-size: 1rem; margin-bottom: 0.5rem; display: flex; align-items: center; gap: 0.5rem;">
                  <i class="fas fa-keyboard" style="color: #f59e0b;"></i>
                  æ‰‹å‹•å…¥åŠ›
                </div>
                <div style="color: #6b7280; font-size: 0.875rem;">
                  CSVå½¢å¼ã§ç›´æ¥ä¼æ¥­ãƒ‡ãƒ¼ã‚¿ã‚’å…¥åŠ›ã—ã¾ã™
                </div>
                
                <!-- Manual Options (shown when selected) -->
                <div id="manualOptions" style="margin-top: 1rem; padding-top: 1rem; border-top: 1px solid #e5e7eb; display: none;">
                  <label style="display: block; margin-bottom: 0.5rem; font-weight: 600; font-size: 0.875rem; color: #374151;">
                    <i class="fas fa-file-csv"></i> ä¼æ¥­ãƒ‡ãƒ¼ã‚¿ï¼ˆ1è¡Œã«ã¤ã1ç¤¾ï¼‰:
                  </label>
                  <textarea
                    id="companyData"
                    rows="6"
                    class="form-control"
                    placeholder="æ³•äººç•ªå·,ä¼æ¥­å,ä½æ‰€,å‚™è€ƒ&#10;1234567890123,æ ªå¼ä¼šç¤¾ã‚µãƒ³ãƒ—ãƒ«,æ±äº¬éƒ½æ¸‹è°·åŒº,ãƒ¡ãƒ¢&#10;9876543210987,ã‚µãƒ³ãƒ—ãƒ«å•†äº‹æ ªå¼ä¼šç¤¾,å¤§é˜ªåºœå¤§é˜ªå¸‚,"
                    style="font-family: monospace; font-size: 0.875rem;"
                  ></textarea>
                  <small style="color: #6b7280; display: block; margin-top: 0.25rem;">
                    ğŸ“Œ CSVå½¢å¼: æ³•äººç•ªå·,ä¼æ¥­å,ä½æ‰€,å‚™è€ƒï¼ˆå„è¡Œ1ç¤¾ãšã¤å…¥åŠ›ï¼‰
                  </small>
                </div>
              </div>
            </label>
          </div>
        </div>

        <!-- STEP 2: Common Options -->
        <div style="background: #f0f9ff; padding: 1.25rem; border-radius: 10px; border: 2px solid #bae6fd;">
          <h4 style="margin: 0 0 1rem 0; color: #0891b2; font-size: 1rem; display: flex; align-items: center; gap: 0.5rem;">
            <i class="fas fa-sliders-h"></i> ã‚¹ãƒ†ãƒƒãƒ—2: ã‚ªãƒ—ã‚·ãƒ§ãƒ³è¨­å®šï¼ˆã™ã¹ã¦ã®ãƒ‡ãƒ¼ã‚¿ã‚½ãƒ¼ã‚¹å…±é€šï¼‰
          </h4>

          <!-- Max Companies -->
          <div style="margin-bottom: 1rem;">
            <label style="display: block; margin-bottom: 0.5rem; font-weight: 600; font-size: 0.875rem; color: #374151;">
              <i class="fas fa-sort-numeric-up"></i> æœ€å¤§ä¼æ¥­æ•°ï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰:
            </label>
            <input
              type="number"
              id="maxCompanies"
              placeholder="ä¾‹: 25"
              min="1"
              max="1000"
              class="form-control"
            />
            <small style="color: #6b7280; display: block; margin-top: 0.25rem;">
              ğŸ“Œ å‡¦ç†ã‚’Xç¤¾ã«åˆ¶é™ï¼ˆç©ºç™½ã§åˆ¶é™ãªã—ï¼‰
            </small>
          </div>

          <!-- Update Google Sheets -->
          <div style="margin-bottom: 1rem; background: white; padding: 0.875rem; border-radius: 6px; border: 1px solid #e5e7eb;">
            <label style="display: flex; align-items: start; margin: 0; cursor: pointer;">
              <input
                type="checkbox"
                id="updateSheets"
                checked
                style="margin-top: 0.125rem; margin-right: 0.75rem; width: 18px; height: 18px; cursor: pointer;"
              />
              <div style="flex: 1;">
                <div style="font-weight: 600; font-size: 0.9375rem; color: #1f2937;">
                  <i class="fas fa-sync-alt" style="color: #8b5cf6;"></i> Googleã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã‚’æ›´æ–°
                </div>
                <small style="color: #6b7280; display: block; margin-top: 0.25rem;">
                  å€‹åˆ¥ä¼æ¥­ã‚·ãƒ¼ãƒˆã‚’ä½œæˆï¼ˆãƒã‚§ãƒƒã‚¯ã‚’å¤–ã™ã¨ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã®ã¿ä¿å­˜ï¼‰
                </small>
              </div>
            </label>
          </div>

          <!-- Description -->
          <div>
            <label style="display: block; margin-bottom: 0.5rem; font-weight: 600; font-size: 0.875rem; color: #374151;">
              <i class="fas fa-tag"></i> èª¬æ˜ï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰:
            </label>
            <input
              type="text"
              id="description"
              placeholder="ä¾‹: 2024å¹´ç¬¬4å››åŠæœŸ ä¼æ¥­æ›´æ–°"
              class="form-control"
            />
            <small style="color: #6b7280; display: block; margin-top: 0.25rem;">
              ğŸ“Œ ã“ã®ã‚¹ã‚¯ãƒ¬ã‚¤ãƒ”ãƒ³ã‚°å®Ÿè¡Œã«ãƒ©ãƒ™ãƒ«ã‚’ä»˜ã‘ã¦ç®¡ç†ã—ã‚„ã™ãã—ã¾ã™
            </small>
          </div>
        </div>

      </form>
    </div>
    <div class="modal-footer" style="flex-shrink: 0;">
      <button
        type="button"
        onclick="hideConfigModal()"
        class="btn btn-secondary"
      >
        <i class="fas fa-times"></i> ã‚­ãƒ£ãƒ³ã‚»ãƒ«
      </button>
      <button
        type="button"
        onclick="startConfiguredScraping()"
        class="btn btn-success"
      >
        <i class="fas fa-play"></i> ã‚¹ã‚¯ãƒ¬ã‚¤ãƒ”ãƒ³ã‚°é–‹å§‹
      </button>
    </div>
  </div>
</div>

<!-- Config Details Modal -->
<div class="modal-overlay" id="configDetailsModal" onclick="if(event.target === this) hideConfigDetailsModal();">
  <div class="modal-content">
    <div class="modal-header">
      <h3><i class="fas fa-info-circle"></i> è¨­å®šè©³ç´°</h3>
      <button
        type="button"
        class="modal-close"
        onclick="hideConfigDetailsModal()"
      >
        <i class="fas fa-times"></i>
      </button>
    </div>
    <div class="modal-body" style="padding-bottom: 2rem;">
      <div
        style="
          background: #f9fafb;
          padding: 1rem;
          border-radius: 6px;
        "
      >
        <div
          style="
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-bottom: 0.75rem;
          "
        >
          <i class="fas fa-hashtag" style="color: #0891b2"></i>
          <strong>å®Ÿè¡ŒID:</strong>
          <code
            id="detailsId"
            style="
              background: #e5e7eb;
              padding: 0.125rem 0.5rem;
              border-radius: 4px;
            "
          ></code>
        </div>
        <div
          style="
            display: flex;
            align-items: flex-start;
            gap: 0.5rem;
            margin-bottom: 0.75rem;
          "
        >
          <i
            class="fas fa-table"
            style="color: #10b981; margin-top: 0.25rem"
          ></i>
          <div>
            <strong>ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆç¯„å›²:</strong>
            <div
              id="detailsRange"
              style="
                color: #374151;
                margin-top: 0.25rem;
                font-family: monospace;
              "
            ></div>
          </div>
        </div>
        <div
          style="
            display: flex;
            align-items: flex-start;
            gap: 0.5rem;
            margin-bottom: 0.75rem;
          "
        >
          <i
            class="fas fa-comment-alt"
            style="color: #f59e0b; margin-top: 0.25rem"
          ></i>
          <div style="flex: 1">
            <strong>èª¬æ˜:</strong>
            <div
              id="detailsDescription"
              style="color: #374151; margin-top: 0.25rem"
            ></div>
          </div>
        </div>
        <div
          style="
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-bottom: 0.75rem;
          "
        >
          <i class="fas fa-building" style="color: #3b82f6"></i>
          <strong>æœ€å¤§ä¼æ¥­æ•°:</strong>
          <span id="detailsMaxCompanies"></span>
        </div>
        <div style="display: flex; align-items: center; gap: 0.5rem">
          <i class="fas fa-file-spreadsheet" style="color: #8b5cf6"></i>
          <strong>Googleã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆæ›´æ–°:</strong>
          <span id="detailsUpdateSheets"></span>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
  function selectDataSource(source) {
      // Update radio buttons
      document.querySelector('input[name="dataSource"][value="' + source + '"]').checked = true;
      toggleDataSource();
  }

  function toggleDataSource() {
      const dataSource = document.querySelector('input[name="dataSource"]:checked').value;
      const sheetsOptions = document.getElementById('sheetsOptions');
      const manualOptions = document.getElementById('manualOptions');
      const sheetsCard = document.getElementById('sheetsCard');
      const manualCard = document.getElementById('manualCard');
      
      if (dataSource === 'sheets') {
          // Show sheets options, hide manual
          sheetsOptions.style.display = 'block';
          manualOptions.style.display = 'none';
          
          // Highlight selected card
          sheetsCard.style.borderColor = '#0891b2';
          sheetsCard.style.background = '#f0f9ff';
          sheetsCard.style.boxShadow = '0 2px 8px rgba(8, 145, 178, 0.15)';
          
          manualCard.style.borderColor = '#e5e7eb';
          manualCard.style.background = 'white';
          manualCard.style.boxShadow = 'none';
      } else {
          // Show manual options, hide sheets
          sheetsOptions.style.display = 'none';
          manualOptions.style.display = 'block';
          
          // Highlight selected card
          manualCard.style.borderColor = '#f59e0b';
          manualCard.style.background = '#fffbeb';
          manualCard.style.boxShadow = '0 2px 8px rgba(245, 158, 11, 0.15)';
          
          sheetsCard.style.borderColor = '#e5e7eb';
          sheetsCard.style.background = 'white';
          sheetsCard.style.boxShadow = 'none';
      }
  }

  function showConfigModal() {
      document.getElementById('configModal').classList.add('active');
      document.body.style.overflow = 'hidden';
      // Initialize card styling
      toggleDataSource();
  }

  function hideConfigModal() {
      document.getElementById('configModal').classList.remove('active');
      document.body.style.overflow = '';
  }

  function showConfigDetails(id, range, description, maxCompanies, updateSheets) {
      document.getElementById('detailsId').textContent = '#' + id;
      document.getElementById('detailsRange').textContent = range || 'æŒ‡å®šãªã—';
      document.getElementById('detailsDescription').textContent = description || 'èª¬æ˜ãªã—';
      document.getElementById('detailsMaxCompanies').textContent = maxCompanies ? maxCompanies + ' ç¤¾' : 'åˆ¶é™ãªã—';

      const updateSheetsEl = document.getElementById('detailsUpdateSheets');
      if (updateSheets) {
          updateSheetsEl.innerHTML = '<span style="color: #10b981;"><i class="fas fa-check-circle"></i> æœ‰åŠ¹</span>';
      } else {
          updateSheetsEl.innerHTML = '<span style="color: #6b7280;"><i class="fas fa-times-circle"></i> ç„¡åŠ¹</span>';
      }

      document.getElementById('configDetailsModal').classList.add('active');
      document.body.style.overflow = 'hidden';
  }

  function hideConfigDetailsModal() {
      document.getElementById('configDetailsModal').classList.remove('active');
      document.body.style.overflow = '';
  }

  // Close modals when clicking outside
  document.addEventListener('click', function(e) {
      if (e.target.classList.contains('modal-overlay')) {
          if (e.target.id === 'configModal') {
              hideConfigModal();
          } else if (e.target.id === 'configDetailsModal') {
              hideConfigDetailsModal();
          }
      }
  });

  // Close modals with Escape key
  document.addEventListener('keydown', function(e) {
      if (e.key === 'Escape') {
          hideConfigModal();
          hideConfigDetailsModal();
      }
  });

  function startConfiguredScraping() {
        const dataSource = document.querySelector('input[name="dataSource"]:checked').value;
        
        const config = {
            data_source: dataSource,
            spreadsheet_range: dataSource === 'sheets' ? document.getElementById('spreadsheetRange').value : null,
            company_data: dataSource === 'manual' ? document.getElementById('companyData').value : null,
            max_companies: document.getElementById('maxCompanies').value ? parseInt(document.getElementById('maxCompanies').value) : null,
            update_google_sheets: document.getElementById('updateSheets').checked,
            description: document.getElementById('description').value
        };

        // Validate manual input
        if (dataSource === 'manual' && (!config.company_data || config.company_data.trim() === '')) {
            showAlert('ä¼æ¥­ãƒ‡ãƒ¼ã‚¿ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚', 'error');
            return;
        }

        // Get CSRF token
        const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]')?.value ||
                         document.querySelector('input[name="csrfmiddlewaretoken"]')?.value ||
                         document.querySelector('meta[name="csrf-token"]')?.getAttribute('content');

        if (!csrfToken) {
            showAlert('CSRFãƒˆãƒ¼ã‚¯ãƒ³ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚ãƒšãƒ¼ã‚¸ã‚’æ›´æ–°ã—ã¦ãã ã•ã„ã€‚', 'error');
            return;
        }

        console.log('Starting scraping with config:', config);
        hideConfigModal();
        showLoading('ã‚¹ã‚¯ãƒ¬ã‚¤ãƒ”ãƒ³ã‚°ãƒ—ãƒ­ã‚»ã‚¹ã‚’é–‹å§‹ã—ã¦ã„ã¾ã™');

        fetch('/admin/api/scrape/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrfToken
            },
            body: JSON.stringify(config)
        })
        .then(response => {
            console.log('Response status:', response.status);
            return response.json();
        })
        .then(data => {
            console.log('Response data:', data);
            hideLoading();
            if (data.status === 'started') {
                const configDetails = `å®Ÿè¡ŒID: #${data.execution_id}
  ç¯„å›²: ${data.config.range}
  ã‚·ãƒ¼ãƒˆæ›´æ–°: ${data.config.update_sheets ? 'ã¯ã„' : 'ã„ã„ãˆ'}
  ${data.config.description ? 'èª¬æ˜: ' + data.config.description : ''}
  ${data.config.max_companies ? 'æœ€å¤§ä¼æ¥­æ•°: ' + data.config.max_companies : ''}`;

                showAlert(configDetails, 'success', 'ã‚¹ã‚¯ãƒ¬ã‚¤ãƒ”ãƒ³ã‚°é–‹å§‹ï¼');
                setTimeout(() => {
                    hideAlert();
                    showLoading('ãƒšãƒ¼ã‚¸ã‚’æ›´æ–°ã—ã¦ã„ã¾ã™');
                    location.reload();
                }, 2500);
            } else {
                showAlert('ã‚¨ãƒ©ãƒ¼: ' + data.message, 'error');
            }
        })
        .catch(error => {
            console.error('Fetch error:', error);
            hideLoading();
            showAlert('ã‚¹ã‚¯ãƒ¬ã‚¤ãƒ”ãƒ³ã‚°é–‹å§‹ã‚¨ãƒ©ãƒ¼: ' + error.message, 'error');
        });
    }

    function startScraping() {
        showConfigModal();
    }
</script>
{% endblock %}